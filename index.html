<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>XR Letter - End Roll</title>

    <!-- Zen Kurenaido -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&display=swap" rel="stylesheet">

    <!-- A-Frame / AR.js -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="./js/aframe-ar.js?v=1.0.2"></script>

    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      .overlay {
        position: fixed;
        z-index: 10;
        top: 10px;
        left: 10px;
        color: white;
        font-family: sans-serif;
      }
    </style>

    <script>
      // ===== エンドロールで流す文章 =====
      const messages = [
        "塩田さんへ",
        "同じ学科の後輩として",
        "同じ班の後輩として",
        "いつも活動できたことが嬉しかったです。",
        "塩田さんは",
        "僕にとって憧れの人です。",
        "明るさにも優しさにも",
        "全てに惹かれています。",
        "塩田さんがXR班をつくったことで",
        "僕はXRという世界に出会いました。",
        "XRに触れた日から",
        "視界が一気に広がりました。",
        "今回の理工展で企画を担当できたのも",
        "塩田さんがいたからです。",
        "来期は、もっと面白いものを作ります。",
        "胸を張って見せられるものを作ります。",
        "このAR手紙には",
        "これからの僕の進捗を",
        "3Dオブジェクトで追加していこうと思っています。",
        "よかったら、また覗きに来てください。",
        "その時、少しでも成長した僕を見せられますように。",
        "本当にありがとうございました。"
      ];

      // 0番目（「塩田さんへ」）は特別演出用
      let currentIndex = 1;
      let spawnAllowed = true;
      let firstDone = false; // 最初の1行が終わったら true

      // ===== 共通：Canvas にテキストを描画（透明背景＋黒文字・中央揃え） =====
      function drawTextToCanvas(text) {
        const canvas = document.getElementById('msgCanvas');
        if (!canvas) return null;
        const ctx = canvas.getContext('2d');

        canvas.width  = 2800;
        canvas.height = 600;

        // 背景は塗らずに透明のまま（白帯は別Planeで用意）
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.font = "90px 'Zen Kurenaido', sans-serif";
        ctx.fillStyle = "#000000";          // 黒文字
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        ctx.fillText(text, canvas.width / 2, canvas.height / 2);

        return canvas;
      }

      // ===== 上に流れて、時間ベースでフェードアウトするコンポーネント =====
      AFRAME.registerComponent('endroll', {
        schema: {
          speed:        { type: 'number', default: 0.28 }, // 移動スピード
          startY:       { type: 'number', default: -0.5 },
          endY:         { type: 'number', default: 1.5 },
          fadeStartY:   { type: 'number', default: 0.25 },
          fadeDuration: { type: 'number', default: 0.9 }   // フェードアウト時間（秒）
        },

        init: function () {
          const el = this.el;
          const data = this.data;
          const pos = el.getAttribute('position') || { x: 0, y: 0, z: 0 };
          pos.y = data.startY;
          el.setAttribute('position', pos);

          this.fadeStartTime = null;
        },

        tick: function (time, dt) {
          const el = this.el;
          const data = this.data;

          const deltaSec = dt / 1000;
          const pos = el.getAttribute('position');
          pos.y += data.speed * deltaSec;
          el.setAttribute('position', pos);

          if (pos.y >= data.fadeStartY && this.fadeStartTime === null) {
            this.fadeStartTime = time;
          }

          if (this.fadeStartTime !== null) {
            const elapsed = (time - this.fadeStartTime) / 1000;
            let alpha = 1 - (elapsed / data.fadeDuration);
            if (alpha < 0) alpha = 0;
            el.setAttribute('material', 'transparent', true);
            el.setAttribute('material', 'opacity', alpha);
          }

          if (pos.y >= data.endY) {
            if (el.parentNode) {
              el.parentNode.removeChild(el);
            }
          }
        }
      });

      // ===== 最初の「塩田さんへ」専用コンポーネント（フェードイン→ホールド→フェードアウト） =====
      AFRAME.registerComponent('firstline', {
        schema: {
          fadeIn:   { type: 'number', default: 1.0 },
          hold:     { type: 'number', default: 3.0 },
          fadeOut:  { type: 'number', default: 1.0 }
        },

        init: function () {
          this.startTime = null;
        },

        tick: function (time, dt) {
          const el = this.el;
          const data = this.data;

          if (this.startTime === null) {
            this.startTime = time;
          }

          const t = (time - this.startTime) / 1000;
          const total = data.fadeIn + data.hold + data.fadeOut;
          let alpha = 0;

          if (t < data.fadeIn) {
            alpha = t / data.fadeIn;
          } else if (t < data.fadeIn + data.hold) {
            alpha = 1;
          } else if (t < total) {
            const t2 = t - (data.fadeIn + data.hold);
            alpha = 1 - (t2 / data.fadeOut);
          } else {
            alpha = 0;
            if (el.parentNode) {
              el.parentNode.removeChild(el);
            }
            firstDone = true;
          }

          el.setAttribute('material', 'transparent', true);
          el.setAttribute('material', 'opacity', alpha);
        }
      });

      // ===== 1 行分の plane（エンドロール用）を生成 =====
      function spawnMessagePlane(text) {
        const marker = document.querySelector('a-marker');
        if (!marker) return;

        const canvas = drawTextToCanvas(text);
        if (!canvas) return;

        const plane = document.createElement('a-plane');
        plane.setAttribute(
          'material',
          'src: #msgCanvas; transparent: true; side: double'
        );

        // Canvas 2800:600 ≒ 4.67:1 → width 2.4 のとき height ≒ 0.51
        plane.setAttribute('width',  '2.4');
        plane.setAttribute('height', '0.51');

        // 白背景planeの少し手前（Zを少しだけ前に）
        plane.setAttribute('position', '0 0 0.12');
        plane.setAttribute('rotation', '0 0 0'); // カメラに正対

        plane.setAttribute(
          'endroll',
          'speed: 0.28; startY: -0.25; endY: 0.85; fadeStartY: 0.25; fadeDuration: 0.7'
        );

        marker.appendChild(plane);
      }

      // ===== 最初の「塩田さんへ」専用 plane を生成 =====
      function spawnFirstMessagePlane() {
        const marker = document.querySelector('a-marker');
        if (!marker) return;

        const canvas = drawTextToCanvas(messages[0]); // 「塩田さんへ」
        if (!canvas) return;

        const plane = document.createElement('a-plane');
        plane.setAttribute(
          'material',
          'src: #msgCanvas; transparent: true; side: double'
        );

        plane.setAttribute('width',  '2.4');
        plane.setAttribute('height', '0.51');
        plane.setAttribute('position', '0 0 0.12');
        plane.setAttribute('rotation', '0 0 0');

        plane.setAttribute('firstline', 'fadeIn: 1.0; hold: 3.0; fadeOut: 1.0');

        marker.appendChild(plane);
      }

      // ===== 一定間隔で 1 行ずつ流すマネージャ =====
      AFRAME.registerComponent('endrollmanager', {
        schema: {
          interval: { type: 'number', default: 4.0 }
        },

        init: function () {
          // 最初に「塩田さんへ」を出す
          spawnFirstMessagePlane();
        },

        tick: function () {
          // まだ最初の1行が終わっていなければエンドロール開始しない
          if (!firstDone) return;

          if (!spawnAllowed) return;
          if (currentIndex >= messages.length) return;

          spawnAllowed = false;
          spawnMessagePlane(messages[currentIndex]);
          currentIndex++;

          if (currentIndex < messages.length) {
            const intervalMs = this.data.interval * 1000;
            setTimeout(() => {
              spawnAllowed = true;
            }, intervalMs);
          }
        }
      });
    </script>
  </head>

  <body>
    <div class="overlay">XR Letter Loading... (End Roll)</div>

    <a-scene
      embedded
      renderer="antialias: true; alpha: true"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <canvas id="msgCanvas"></canvas>
      </a-assets>

      <!-- Hiro マーカー -->
      <a-marker preset="hiro" endrollmanager>
        <!-- ★ 常に表示される白い縦長背景 -->
        <a-plane
          color="#ffffff"
          width="2.4"
          height="2.0"
          position="0 0 0.1"
          rotation="0 0 0"
          opacity="0.95"
        ></a-plane>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
