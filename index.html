<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>XR Letter - End Roll</title>

    <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&display=swap" rel="stylesheet">

    
    <!-- A-Frame / AR.js -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="./js/aframe-ar.js?v=1.0.2"></script>

    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      .overlay {
        position: fixed;
        z-index: 10;
        top: 10px;
        left: 10px;
        color: white;
        font-family: sans-serif;
      }
    </style>

    <script>
      // ===== エンドロールで流す文章 =====
      const messages = [
        "塩田さんへ",
        "同じ学科の後輩として",
        "同じ班の後輩として",
        "いつも活動できたことが嬉しかったです。",
        "塩田さんは",
        "僕にとって憧れの人です。",
        "明るさにも優しさにも",
        "全てに惹かれています。",
        "塩田さんがXR班をつくったことで",
        "僕はXRという世界に出会いました。",
        "XRに触れた日から",
        "視界が一気に広がりました。",
        "今回の理工展で企画を担当できたのも",
        "塩田さんがいたからです。",
        "来期は、もっと面白いものを作ります。",
        "胸を張って見せられるものを作ります。",
        "このAR手紙には",
        "これからの僕の進捗を",
        "3Dオブジェクトで追加していこうと思っています。",
        "よかったら、また覗きに来てください。",
        "その時、少しでも成長した僕を見せられますように。",
        "本当にありがとうございました。"
      ];

      let currentIndex = 0;
      let spawnAllowed = true;

      // ===== 上に流れて、時間ベースでフェードアウトするコンポーネント =====
      AFRAME.registerComponent('endroll', {
        schema: {
          speed:        { type: 'number', default: 0.28 }, // 移動スピード（固定）
          startY:       { type: 'number', default: -0.25 },
          endY:         { type: 'number', default: 0.85 },
          fadeStartY:   { type: 'number', default: 0.25 },
          fadeDuration: { type: 'number', default: 0.7 }   // ★ フェードアウト時間（秒）
        },

        init: function () {
          const el = this.el;
          const data = this.data;
          const pos = el.getAttribute('position') || { x: 0, y: 0, z: 0 };
          pos.y = data.startY;
          el.setAttribute('position', pos);

          this.fadeStartTime = null; // フェード開始時刻
        },

        tick: function (time, dt) {
          const el = this.el;
          const data = this.data;

          // 上方向に移動
          const deltaSec = dt / 1000;
          const pos = el.getAttribute('position');
          pos.y += data.speed * deltaSec;
          el.setAttribute('position', pos);

          // フェード開始位置に来たら時間計測開始
          if (pos.y >= data.fadeStartY && this.fadeStartTime === null) {
            this.fadeStartTime = time;
          }

          // フェードアウト処理（時間ベース）
          if (this.fadeStartTime !== null) {
            const elapsed = (time - this.fadeStartTime) / 1000; // 経過秒
            let alpha = 1 - (elapsed / data.fadeDuration);
            if (alpha < 0) alpha = 0;
            el.setAttribute('material', 'transparent', true);
            el.setAttribute('material', 'opacity', alpha);
          }

          // 画面上端を超えたら削除
          if (pos.y >= data.endY) {
            if (el.parentNode) {
              el.parentNode.removeChild(el);
            }
          }
        }
      });

      // ===== 1 行分の plane を生成して canvas に描く =====
      function spawnMessagePlane(text) {
        const marker = document.querySelector('a-marker');
        if (!marker) return;

        const canvas = document.getElementById('msgCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        canvas.width  = 2800;
        canvas.height = 600;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "82px 'Zen Kurenaido', sans-serif";
        ctx.fillStyle = "#ffffff";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";
        ctx.fillText(text, 80, canvas.height / 2);
        ctx.shadowColor = "rgba(0, 0, 0, 0.55)";
        ctx.shadowBlur = 12;

        const plane = document.createElement('a-plane');
        plane.setAttribute(
          'material',
          'src: #msgCanvas; transparent: true; side: double'
        );
        plane.setAttribute('height', '0.65');
        plane.setAttribute('width',  '2.4');
        plane.setAttribute('position', '0 0 0.15');
        plane.setAttribute('rotation', '0 0 0'); // マーカー上に寝かせる

        // ★ フェード時間だけここで調整すればOK
        plane.setAttribute(
          'endroll',
          'speed: 0.22; startY: -0.25; endY: 0.85; fadeStartY: 0.25; fadeDuration: 0.7'
        );

        marker.appendChild(plane);
      }

      // ===== 一定間隔で 1 行ずつ流すマネージャ =====
      AFRAME.registerComponent('endrollmanager', {
        schema: {
          interval: { type: 'number', default: 4.0 } // 次の行が出るまでの間隔（秒）
        },

        tick: function () {
          if (!spawnAllowed) return;
          if (currentIndex >= messages.length) return;

          spawnAllowed = false;
          spawnMessagePlane(messages[currentIndex]);
          currentIndex++;

          if (currentIndex < messages.length) {
            const intervalMs = this.data.interval * 1000;
            setTimeout(() => {
              spawnAllowed = true;
            }, intervalMs);
          }
        }
      });
    </script>
  </head>

  <body>
    <div class="overlay">XR Letter Loading... (End Roll)</div>

    <a-scene
      embedded
      renderer="antialias: true; alpha: true"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <canvas id="msgCanvas"></canvas>
      </a-assets>

      <!-- Hiro マーカー -->
      <a-marker preset="hiro" endrollmanager>
        <!-- 必要ならここに赤い板を戻してもOK -->
        <!--
        <a-plane
          color="#bf2d2d"
          height="2"
          width="2"
          position="0 0 0"
          rotation="-90 0 0"
          opacity="0.40"
        ></a-plane>
        -->
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
