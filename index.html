<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>XR Letter - End Roll</title>

    <!-- A-Frame（AR.js 3.4.7 に対応する 1.6.0） -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- ローカルに保存した AR.js -->
    <script src="./js/aframe-ar.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      .overlay {
        position: fixed;
        z-index: 10;
        top: 10px;
        left: 10px;
        color: white;
        font-family: sans-serif;
      }
    </style>

    <script>
      // 「今までありがとうございました！」を上に流してフェードアウトさせるコンポーネント
      AFRAME.registerComponent('endroll', {
        schema: {
          speed: { type: 'number', default: 0.25 },     // 上に動く速さ（m/秒）
          startY: { type: 'number', default: -0.10 },    // 出てくる高さ
          endY:   { type: 'number', default: 0.40 },     // 消える高さ
          fadeStartY: { type: 'number', default: 0.10 }  // フェードアウト開始位置
        },

        init: function () {
          var data = this.data;
          var el = this.el;

          // 初期位置をセット
          var pos = el.getAttribute('position') || {x: 0, y: 0, z: 0};
          pos.y = data.startY;
          el.setAttribute('position', pos);

          this.baseOpacity = 1.0;
        },

        tick: function (time, dt) {
          var data = this.data;
          var el = this.el;

          var deltaSec = dt / 1000;
          var pos = el.getAttribute('position');
          pos.y += data.speed * deltaSec;
          el.setAttribute('position', pos);

          var y = pos.y;

          // フェードアウト
          if (y >= data.fadeStartY) {
            var t = (y - data.fadeStartY) / (data.endY - data.fadeStartY);
            var alpha = Math.max(0, 1 - t) * this.baseOpacity;

            el.setAttribute('text', 'opacity', alpha);
            el.setAttribute('material', 'opacity', alpha);
            el.setAttribute('material', 'transparent', true);
          }

          // しきい値を超えたら削除
          if (y >= data.endY) {
            if (el.parentNode) {
              el.parentNode.removeChild(el);
            }
          }
        }
      });
    </script>
  </head>

  <body>
    <div class="overlay">XR Letter Loading... (End Roll)</div>

    <a-scene
      embedded
      renderer="antialias: true; alpha: true"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <!-- Hiroマーカー -->
      <a-marker preset="hiro">
        <a-entity rotation="-90 0 0">
            <a-entity
            geometry="primitive: plane; height: 0.5; width: 1.5"
            material="color: #00ff00; opacity: 0.8; side: double"
            text="value: HELLO; align: center; color: #000000; width: 3; side: double"
            position="0 0.3 0"
            ></a-entity>
        </a-entity>
       </a-marker>


      <!-- カメラ -->
      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
