<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>XR Letter - Scroll Credits</title>

    <!-- Zen Kurenaido -->
    <link href="https://fonts.googleapis.com/css2?family=Zen+Kurenaido&display=swap" rel="stylesheet">

    <!-- A-Frame / AR.js -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="./js/aframe-ar.js?v=1.0.2"></script>

    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      .overlay {
        position: fixed;
        z-index: 10;
        top: 10px;
        left: 10px;
        color: white;
        font-family: sans-serif;
      }
    </style>

    <script>
      // ===== スクロールさせる文章（連続クレジット用） =====
      const messages = [
        "塩田さんへ",
        "",
        "同じ学科の後輩として、",
        "同じ班の後輩として、",
        "いつも活動できたことが嬉しかったです。",
        "",
        "塩田さんは、",
        "僕にとって憧れの人です。",
        "明るさにも、優しさにも、",
        "全てに惹かれています。",
        "",
        "塩田さんがXR班をつくったことで、",
        "僕はXRという世界に出会いました。",
        "XRに触れた日から、",
        "視界が一気に広がりました。",
        "",
        "今回の理工展で企画を担当できたのも、",
        "塩田さんがいたからです。",
        "",
        "来期は、もっと面白いものを作ります。",
        "胸を張って見せられるものを作ります。",
        "",
        "このAR手紙には、",
        "これからの僕の進捗を、",
        "3Dオブジェクトで追加していこうと思っています。",
        "",
        "よかったら、また覗きに来てください。",
        "その時、少しでも成長した僕を",
        "見せられますように。",
        "",
        "本当にありがとうございました。"
      ];

      // ===== スクロール用テクスチャをCanvasに描く =====
      function buildScrollTexture() {
        const canvas = document.getElementById('msgCanvas');
        if (!canvas) return null;
        const ctx = canvas.getContext('2d');

        const width = 2048;          // テクスチャ幅
        const lineHeight = 120;      // 行間
        const marginTop = 200;
        const marginBottom = 200;

        const totalHeight = marginTop + marginBottom + lineHeight * messages.length;

        canvas.width = width;
        canvas.height = totalHeight;

        // 背景は透明（白帯は別planeで用意）
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.font = "80px 'Zen Kurenaido', sans-serif";
        ctx.fillStyle = "#000000";       // 黒文字
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        let y = marginTop;
        for (let i = 0; i < messages.length; i++) {
          const text = messages[i];
          if (text && text.trim().length > 0) {
            ctx.fillText(text, canvas.width / 2, y);
          }
          y += lineHeight;
        }

        return {
          canvas,
          width: canvas.width,
          height: canvas.height
        };
      }

      // ===== スクロール挙動を司るコンポーネント（1枚の長いplaneを動かす） =====
      AFRAME.registerComponent('scrollcredit', {
        schema: {
          duration: { type: 'number', default: 10.0 }, // 下→上に抜けるまでの時間（秒）
          startY:   { type: 'number', default: -1.1 }, // 白帯の少し下から出てくる
          endY:     { type: 'number', default: 1.1 }   // 白帯の少し上で抜ける
        },

        init: function () {
          this.startTime = null;
        },

        tick: function (time, dt) {
          if (this.startTime === null) {
            this.startTime = time;
          }
          const data = this.data;
          const el = this.el;

          const t = (time - this.startTime) / 1000; // 経過秒
          const progress = Math.min(t / data.duration, 1.0);

          const y = data.startY + (data.endY - data.startY) * progress;

          const pos = el.getAttribute('position') || { x: 0, y: 0, z: 0 };
          pos.y = y;
          el.setAttribute('position', pos);

          // 10秒経ったら少しフェードアウトして消える
          if (progress >= 1.0) {
            // フェードアウトを軽くかける（オプション）
            el.setAttribute('material', 'transparent', true);
            el.setAttribute('material', 'opacity', 0.0);

            // 要らなければ削除してもOK
            // if (el.parentNode) el.parentNode.removeChild(el);
          }
        }
      });

      // ===== スクロール用planeを一度だけ生成するマネージャ =====
      AFRAME.registerComponent('scrollcredit-manager', {
        init: function () {
          const marker = this.el; // a-marker
          const tex = buildScrollTexture();
          if (!tex) return;

          const plane = document.createElement('a-plane');
          plane.setAttribute(
            'material',
            'src: #msgCanvas; transparent: true; side: double'
          );

          // キャンバスのアスペクト比に合わせてplaneサイズ決定
          const planeWidth = 2.2; // 白帯(2.4)より少し小さく
          const aspect = tex.height / tex.width;
          const planeHeight = planeWidth * aspect;

          plane.setAttribute('width', planeWidth);
          plane.setAttribute('height', planeHeight);

          // 最初は startY の位置から出発（zは白帯より少し手前）
          const startY = -1.1;
          plane.setAttribute('position', `0 ${startY} 0.12`);
          plane.setAttribute('rotation', '0 0 0');

          // スクロール設定：10秒で下→上へ
          plane.setAttribute(
            'scrollcredit',
            'duration: 10; startY: -1.1; endY: 1.1'
          );

          marker.appendChild(plane);
        }
      });
    </script>
  </head>

  <body>
    <div class="overlay">XR Letter Loading... (Scroll Credits)</div>

    <a-scene
      embedded
      renderer="antialias: true; alpha: true"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <canvas id="msgCanvas"></canvas>
      </a-assets>

      <!-- Hiro マーカー -->
      <!-- scrollcredit-manager が中でスクロールplaneを1枚生成 -->
      <a-marker preset="hiro" scrollcredit-manager>
        <!-- ★ 常に表示される白い縦長背景 -->
        <a-plane
          color="#ffffff"
          width="2.4"
          height="2.0"
          position="0 0 0.1"
          rotation="0 0 0"
          opacity="0.97"
        ></a-plane>
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
