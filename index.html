<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>XR Letter - End Roll</title>

    <!-- A-Frame / AR.js -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="./js/aframe-ar.js?v=1.0.2"></script>

    <!-- キャッシュ対策 -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <style>
      body {
        margin: 0;
        overflow: hidden;
      }
      .overlay {
        position: fixed;
        z-index: 10;
        top: 10px;
        left: 10px;
        color: white;
        font-family: sans-serif;
      }
    </style>

    <script>
      // ===== エンドロールで流す文章 =====
      const messages = [
        "塩田さんへ",
        "同じ学科の後輩として",
        "同じ班の後輩として",
        "いつも活動できたことが嬉しかったです。",
        "塩田さんは",
        "僕にとって憧れの人です。",
        "明るさにも",
        "優しさにも",
        "全てに惹かれています。",
        "塩田さんがXR班をつくったことで",
        "僕はXRという世界に出会いました。",
        "XRに触れた日から",
        "視界が一気に広がりました。",
        "今回の理工展で企画を担当できたのも",
        "塩田さんがいたからです。",
        "来期は、もっと面白いものを作ります。",
        "胸を張って見せられるものを作ります。",
        "このAR手紙には",
        "これからの僕の進捗を",
        "3Dオブジェクトで追加していこうと思っています。",
        "よかったら、また覗きに来てください。",
        "その時、少しでも成長した僕を見せられますように。",
        "本当にありがとうございました。"
      ];

      let currentIndex = 0;
      let spawnAllowed = true;

      // ===== 上に流れてフェードアウトするコンポーネント =====
      AFRAME.registerComponent("endroll", {
        schema: {
          speed: { type: "number", default: 0.22 },
          startY: { type: "number", default: -0.25 },
          endY: { type: "number", default: 0.85 },
          fadeStartY: { type: "number", default: 0.25 }
        },

        init: function () {
          const data = this.data;
          const el = this.el;
          const pos = el.getAttribute("position") || { x: 0, y: 0, z: 0 };
          pos.y = data.startY;
          el.setAttribute("position", pos);
          this.baseOpacity = 1.0;
        },

        tick: function (time, dt) {
          const data = this.data;
          const el = this.el;

          const deltaSec = dt / 1000;
          const pos = el.getAttribute("position");
          pos.y += data.speed * deltaSec;
          el.setAttribute("position", pos);

          const y = pos.y;

          // フェードアウト
          if (y >= data.fadeStartY) {
            const t = (y - data.fadeStartY) / (data.endY - data.fadeStartY);
            const alpha = Math.max(0, 1 - t) * this.baseOpacity;
            el.setAttribute("material", "opacity", alpha);
            el.setAttribute("material", "transparent", true);
          }

          // 画面上端を超えたら削除
          if (y >= data.endY) {
            if (el.parentNode) {
              el.parentNode.removeChild(el);
            }
          }
        }
      });

      // ===== 1行分の plane を生成して canvas に描く =====
      function spawnMessagePlane(text) {
        const marker = document.querySelector("a-marker");
        if (!marker) return;

        const canvas = document.getElementById("msgCanvas");
        if (!canvas) return;

        const ctx = canvas.getContext("2d");

        canvas.width = 1400;
        canvas.height = 300;

        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.font = "bold 80px 'Yu Gothic', 'Noto Sans JP', sans-serif";
        ctx.fillStyle = "#ffffff";
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";

        ctx.fillText(text, 80, canvas.height / 2);

        const plane = document.createElement("a-plane");
        plane.setAttribute(
          "material",
          "src: #msgCanvas; transparent: true; side: double"
        );
        plane.setAttribute("height", "0.65");
        plane.setAttribute("width", "2.4");
        plane.setAttribute("position", "0 0 0.15");
        plane.setAttribute("rotation", "0 0 0");
        plane.setAttribute(
          "endroll",
          "speed: 0.22; startY: -0.25; endY: 0.85; fadeStartY: 0.25"
        );

        marker.appendChild(plane);
      }

      // ===== 一定間隔で 1 行ずつ流すマネージャ =====
      AFRAME.registerComponent('endroll', {
        schema: {
          speed: { type: 'number', default: 0.25 },
          startY: { type: 'number', default: -0.10 },
          endY: { type: 'number', default: 0.40 },
          fadeStartY: { type: 'number', default: 0.10 },
          fadeDuration: { type: 'number', default: 0.6 } // ★ フェードアウト時間（秒）
        },
      
        init: function () {
          var el = this.el;
          var pos = el.getAttribute('position') || {x: 0, y: 0, z: 0};
          pos.y = this.data.startY;
          el.setAttribute('position', pos);
      
          this.fadeStartTimer = null; // ★ フェード開始時刻
        },
      
        tick: function (time, dt) {
          var data = this.data;
          var el = this.el;
      
          var deltaSec = dt / 1000;
          var pos = el.getAttribute('position');
          pos.y += data.speed * deltaSec;
          el.setAttribute('position', pos);
      
          // フェード開始位置に達したらタイマー開始
          if (pos.y >= data.fadeStartY && this.fadeStartTimer === null) {
            this.fadeStartTimer = time;
          }
      
          // フェードアウト処理
          if (this.fadeStartTimer !== null) {
            var elapsed = (time - this.fadeStartTimer) / 1000; // 秒
            var alpha = Math.max(0, 1 - elapsed / data.fadeDuration);
            el.setAttribute('material', 'transparent', true);
            el.setAttribute('material', 'opacity', alpha);
          }
      
          // 一定高さを超えたら削除
          if (pos.y >= data.endY) {
            if (el.parentNode) {
              el.parentNode.removeChild(el);
            }
          }
        }
      });

    </script>
  </head>

  <body>
    <div class="overlay">XR Letter Loading... (End Roll)</div>

    <a-scene
      embedded
      renderer="antialias: true; alpha: true"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; debugUIEnabled: false;"
    >
      <a-assets>
        <canvas id="msgCanvas"></canvas>
      </a-assets>

      <!-- Hiro マーカー -->
      <a-marker preset="hiro" endrollmanager>
        <!-- 背景の赤い板 -->
        
      </a-marker>

      <a-entity camera></a-entity>
    </a-scene>
  </body>
</html>
